name: Build PyPI Client

on:
    push:
        # Trigger on any branch push for testing
    pull_request:

permissions:
    contents: read

jobs:
    build-client:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout fyn-api repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.12"

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y openjdk-11-jre-headless
                  npm install -g @openapitools/openapi-generator-cli

            - name: Install Python dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install build
                  pip install -r requirements.txt

            - name: Get current tag version
              id: get_version
              run: |
                  # Get the latest semver tag (exclude 'latest' tag), strip 'v' prefix
                  VERSION=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | head -1 | sed 's/^v//')
                  if [ -z "$VERSION" ]; then
                    echo "Error: No valid semver tag found"
                    exit 1
                  fi
                  echo "Current version from tags: ${VERSION}"
                  echo "version=${VERSION}" >> $GITHUB_OUTPUT

            - name: Generate OpenAPI spec
              run: |
                  python manage.py spectacular --file fyn_api_client.yaml

            - name: Generate Python API client
              run: |
                  # Use the tag version for the client
                  CLIENT_VERSION="${{ steps.get_version.outputs.version }}"
                  echo "Generating client with version: ${CLIENT_VERSION}"

                  openapi-generator-cli generate \
                    -i fyn_api_client.yaml \
                    -g python \
                    -o ./fyn_api_client \
                    --additional-properties=packageName=fyn_api_client,packageVersion=${CLIENT_VERSION}

            - name: Build client package
              run: |
                  cd fyn_api_client
                  python -m build

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: fyn-api-client-distributions
                  path: fyn_api_client/dist/
