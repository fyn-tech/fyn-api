packages:
  yum:
    jq: []

container_commands:
  01_create_env_file:
    command: |
      # Create the directory if it doesn't exist
      mkdir -p /opt/elasticbeanstalk/deployment
      
      # Create and populate the environment file
      /opt/elasticbeanstalk/bin/get-config environment | jq -r 'to_entries | .[] | "export \(.key)=\(.value)"' > /opt/elasticbeanstalk/deployment/env_vars
      
      # Make it executable and set proper permissions
      chmod 755 /opt/elasticbeanstalk/deployment/env_vars
      
      # Verify file was created and has content
      if [ ! -s /opt/elasticbeanstalk/deployment/env_vars ]; then
        echo "Environment file creation failed"
        exit 1
      fi
      
      echo "Environment file created successfully"
      
  02_collectstatic:
    command: |
      if [ -f /opt/elasticbeanstalk/deployment/env_vars ]; then
        source /opt/elasticbeanstalk/deployment/env_vars
        sudo -u webapp /var/app/venv/*/bin/python manage.py collectstatic --noinput
      else
        echo "Environment file not found"
        exit 1
      fi
    
  03_migrate:
    command: |
      if [ -f /opt/elasticbeanstalk/deployment/env_vars ]; then
        source /opt/elasticbeanstalk/deployment/env_vars
        sudo -u webapp /var/app/venv/*/bin/python manage.py migrate
      else
        echo "Environment file not found"
        exit 1
      fi
    leader_only: true

option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: fyn-api.wsgi:application
  aws:elasticbeanstalk:environment:proxy:staticfiles:
    /static: static