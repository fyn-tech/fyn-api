packages:
  yum:
    jq: []

container_commands:
  01_create_env_file:
    command: |
      # Create the directory if it doesn't exist
      mkdir -p /opt/elasticbeanstalk/deployment
      
      # Create and populate the environment file for EB internal use
      /opt/elasticbeanstalk/bin/get-config environment | jq -r 'to_entries | .[] | "export \(.key)=\(.value)"' > /opt/elasticbeanstalk/deployment/env_vars
      
      # Create a .env file for Django in the application directory
      /opt/elasticbeanstalk/bin/get-config environment | jq -r 'to_entries | .[] | "\(.key)=\(.value)"' > /var/app/staging/.env
      
      # Set proper ownership and permissions
      chown webapp:webapp /var/app/staging/.env
      chmod 600 /var/app/staging/.env
      
      # Make the EB env file executable
      chmod 755 /opt/elasticbeanstalk/deployment/env_vars
      
      # Verify files were created and have content
      if [ ! -s /opt/elasticbeanstalk/deployment/env_vars ]; then
        echo "Environment file creation failed"
        exit 1
      fi
      if [ ! -s /var/app/staging/.env ]; then
        echo "Django .env file creation failed"
        exit 1
      fi
      
      echo "Environment files created successfully"
      
  02_collectstatic:
    command: |
      if [ -f /opt/elasticbeanstalk/deployment/env_vars ]; then
        echo "Found env_vars file"
        cat /opt/elasticbeanstalk/deployment/env_vars
        source /opt/elasticbeanstalk/deployment/env_vars
        echo "Current directory: $(pwd)"
        echo "Checking .env file:"
        ls -la .env
        echo "Running collectstatic..."
        sudo -u webapp /var/app/venv/*/bin/python manage.py collectstatic --noinput --verbosity 2
      else
        echo "Environment file not found"
        exit 1
      fi
    
  03_migrate:
    command: |
      if [ -f /opt/elasticbeanstalk/deployment/env_vars ]; then
        source /opt/elasticbeanstalk/deployment/env_vars
        sudo -u webapp /var/app/venv/*/bin/python manage.py migrate
      else
        echo "Environment file not found"
        exit 1
      fi
    leader_only: true

option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: fyn-api.wsgi:application
  aws:elasticbeanstalk:environment:proxy:staticfiles:
    /static: static